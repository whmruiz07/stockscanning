
# Streamlit Momentum Screener ‚Äî "ÈÅ∏ËÇ°Á•ûÂô® (Beta)"
# Author: ChatGPT for Homan
# Changelog (2025-08-15):
# - ‰øÆÊ≠£ÔºöS&P 500 Ê∏ÖÂñÆÂèñÂæóÂ§±ÊïóÊôÇÁöÑÁ©©ÂÅ•ÊñπÊ°àÔºàÂÑ™ÂÖàÁî® yfinance.tickers_sp500ÔºåÊîπ‰ª• GitHub CSV ÁÇ∫ÂæåÊè¥Ôºâ„ÄÇ
# - ÊîπÂñÑÔºöNASDAQ 100 Â§±ÊïóÊôÇÊòéÁ¢∫ÊèêÁ§∫ÊîπÁî®Ëá™Ë®ÇÊ∏ÖÂñÆÔºåÊàñÊâãÂãïË≤º‰∏ä‰ª£Ëôü„ÄÇ

import streamlit as st
import pandas as pd
import numpy as np
import datetime as dt
import math
import requests

# External data
import yfinance as yf

# ---------------------------
# Utility: technicals
# ---------------------------
def sma(series, window):
    return series.rolling(window).mean()

def ema(series, window):
    return series.ewm(span=window, adjust=False).mean()

def rsi(series, period: int = 14):
    # Wilder's RSI
    delta = series.diff()
    gain = (delta.where(delta > 0, 0)).rolling(period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(period).mean()
    rs = gain / (loss.replace(0, np.nan))
    rsi = 100 - (100 / (1 + rs))
    return rsi

def atr(high, low, close, period: int = 14):
    prev_close = close.shift(1)
    tr = pd.concat([high - low, (high - prev_close).abs(), (low - prev_close).abs()], axis=1).max(axis=1)
    return tr.rolling(period).mean()

def pct_change(series, periods):
    with np.errstate(divide="ignore", invalid="ignore"):
        return (series / series.shift(periods) - 1.0) * 100.0

def safe_div(a, b):
    try:
        return float(a) / float(b) if float(b) != 0 else np.nan
    except Exception:
        return np.nan

# ---------------------------
# Config
# ---------------------------
st.set_page_config(page_title="ÈÅ∏ËÇ°Á•ûÂô®ÔΩúMomentum Screener", layout="wide")
st.title("üöÄ ÈÅ∏ËÇ°Á•ûÂô®ÔºàMomentum ScreenerÔºâ")
st.caption("ÂπæÂÄãÊåâÈàïÊâæÂãïËÉΩÂº∑ÁöÑÁæéËÇ°Ôºå‰∏¶Ëá™ÂãïÁµ¶Âá∫Ê≠¢Ë≥∫/Ê≠¢ËùïÂÉπÊ†º„ÄÇ")

# Sidebar ‚Äî universe & params
with st.sidebar:
    st.header("‚öôÔ∏è ÂèÉÊï∏Ë®≠ÂÆö")
    universe = st.selectbox("ËÇ°Á•®ÁØÑÂúç", ["S&P 500", "NASDAQ 100", "Ëá™Ë®ÇÔºàË≤º‰∏ä‰ª£ËôüÔºåÈÄóËôüÊàñÁ©∫ÁôΩÂàÜÈöîÔºâ"])
    lookback_1 = st.selectbox("Áü≠ÊúüÂãïËÉΩÔºàÂ§©Ôºâ", [10, 20, 21, 30], index=2)
    lookback_3 = st.selectbox("‰∏≠ÊúüÂãïËÉΩÔºàÂ§©Ôºâ", [42, 60, 63, 90], index=2)
    lookback_6 = st.selectbox("Èï∑ÊúüÂãïËÉΩÔºàÂ§©Ôºâ", [126, 180, 200, 252], index=0)
    min_dollar_vol = st.number_input("ÊúÄ‰ΩéÂπ≥ÂùáÊó•Êàê‰∫§È°çÔºàÁæéÂÖÉÔºâ", min_value=0, value=2_000_000, step=500_000, help="‰ª•Ëøë20Êó•Âπ≥ÂùáÊàê‰∫§È°çÔºàÊàê‰∫§Èáè*Êî∂Áõ§ÔºâË®à„ÄÇ")
    top_n = st.slider("È°ØÁ§∫Ââç N Âêç", 5, 50, 15, step=5)
    entry_mode = st.radio("ÂÖ•Â†¥ÂÉπÊ†º", ["‰ΩøÁî®ÊúÄÊñ∞Êî∂Áõ§ÂÉπ", "Ëá™Ë®ÇÂÖ•Â†¥ÂÉπ"])
    custom_entry = st.number_input("Ëá™Ë®ÇÂÖ•Â†¥ÂÉπÔºàÁï∂ÈÅ∏ÂñÆËÇ°ÊôÇÊâçÊúÉÁî®Ôºâ", value=0.0, min_value=0.0, step=0.01, format="%.2f")
    risk_multiple_tp = st.select_slider("Ê≠¢Ë≥∫ÂÄçÊï∏ÔºàRÔºâ", options=[1.5, 2.0, 2.5, 3.0], value=2.0)
    atr_k = st.select_slider("ATR ÂÄçÊï∏Ê≠¢Ëùï", options=[1.5, 2.0, 2.5, 3.0], value=2.0)
    min_price = st.number_input("ÊúÄ‰ΩéËÇ°ÂÉπÔºàÈÅéÊøæ‰ΩéÂÉπËÇ°Ôºâ", min_value=0.0, value=5.0, step=1.0)
    run_scan = st.button("üîç ‰∏ÄÈçµÊéÉÊèè")

# ---------------------------
# Robust universe fetchers
# ---------------------------
@st.cache_data(show_spinner=False)
def get_sp500_tickers():
    # 1) Use yfinance (ÂÖßÂª∫Á∂≠Ë≠∑‰æÜÊ∫êÔºåÊØîÁõ¥Êé•Êäì wiki Á©©ÂÆö)
    try:
        syms = yf.tickers_sp500()
        if syms and isinstance(syms, (list, tuple)):
            return sorted([s.replace(".", "-").upper() for s in syms])
    except Exception:
        pass

    # 2) Fallback to GitHub CSVÔºàDataHub Â∞àÊ°àÔºâ
    try:
        url = "https://raw.githubusercontent.com/datasets/s-and-p-500-companies/main/data/constituents.csv"
        df = pd.read_csv(url)
        syms = df["Symbol"].dropna().astype(str).str.replace(".", "-", regex=False).str.upper().unique().tolist()
        return sorted(syms)
    except Exception:
        return []

@st.cache_data(show_spinner=False)
def get_nasdaq100_tickers():
    # 1) Wikipedia with requests headers ‚Üí pandas.read_html on HTML text
    try:
        headers = {"User-Agent": "Mozilla/5.0 (compatible; MomentumScreener/1.0)"}
        html = requests.get("https://en.wikipedia.org/wiki/NASDAQ-100", headers=headers, timeout=10).text
        tables = pd.read_html(html)
        # ÂòóË©¶Â∞ãÊâæÂåÖÂê´ Symbol/Ticker ÁöÑË°®
        for tbl in tables:
            cols = [c.lower() for c in tbl.columns.astype(str)]
            if any("symbol" in c or "ticker" in c for c in cols):
                col = tbl.columns[[("Symbol" in str(c)) or ("Ticker" in str(c)) for c in tbl.columns]].tolist()[0]
                syms = tbl[col].dropna().astype(str).str.replace(".", "-", regex=False).str.upper().tolist()
                # ÊøæÊéâÈùûÂ≠óÊØçÊï∏Â≠óÁ¨¶Ëôü
                syms = [s for s in syms if s.isascii()]
                if len(syms) >= 80:  # ÂêàÁêÜÈñÄÊ™ª
                    return sorted(list(dict.fromkeys(syms)))
    except Exception:
        pass

    # 2) FallbackÔºöÊòéÁ¢∫ÊèêÁ§∫‰ΩøÁî®ËÄÖÊîπÁî®„ÄåËá™Ë®ÇÊ∏ÖÂñÆ„Äç
    return []

@st.cache_data(show_spinner=False)
def get_universe_tickers(kind: str):
    if kind == "S&P 500":
        return get_sp500_tickers()
    elif kind == "NASDAQ 100":
        syms = get_nasdaq100_tickers()
        if not syms:
            st.warning("ÁÑ°Ê≥ïÁ©©ÂÆöÂèñÂæó NASDAQ 100 Ê∏ÖÂñÆ„ÄÇË´ãÊîπÁî®„ÄåËá™Ë®ÇÊ∏ÖÂñÆ„Äç‰∏¶Ë≤º‰∏ä‰ª£ËôüÔºàÊàñÁ®çÂæåÈáçË©¶Ôºâ„ÄÇ")
        return syms
    else:
        return []

# ---------------------------
# Data & indicators
# ---------------------------
import yfinance as yf

@st.cache_data(show_spinner=True, ttl=3600)
def fetch_history(tickers, period="400d"):
    data = yf.download(tickers=tickers, period=period, auto_adjust=True, threads=True, group_by="ticker", progress=False)
    return data

def average_dollar_volume(close, volume, window=20):
    return (close * volume).rolling(window).mean()

def rsi(series, period: int = 14):
    delta = series.diff()
    gain = (delta.where(delta > 0, 0)).rolling(period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(period).mean()
    rs = gain / (loss.replace(0, np.nan))
    return 100 - (100 / (1 + rs))

def pct_change(series, periods):
    with np.errstate(divide="ignore", invalid="ignore"):
        return (series / series.shift(periods) - 1.0) * 100.0

def atr(high, low, close, period: int = 14):
    prev_close = close.shift(1)
    tr = pd.concat([high - low, (high - prev_close).abs(), (low - prev_close).abs()], axis=1).max(axis=1)
    return tr.rolling(period).mean()

def compute_levels(close_series, atr_series, atr_mult=2.0):
    last_close = float(close_series.iloc[-1])
    last_atr = float(atr_series.iloc[-1])
    swing_low = float(close_series.rolling(20).min().iloc[-1])
    atr_stop = last_close - atr_mult * last_atr
    stop = max(atr_stop, swing_low)
    risk = max(last_close - stop, 0.01)
    tp1 = last_close + risk
    tp2 = last_close + 2 * risk
    tp3 = last_close + 3 * risk
    return last_close, stop, tp1, tp2, tp3, risk

def format_price(x):
    try:
        return f"{float(x):.2f}"
    except Exception:
        return ""

def score_row(row, lookback_1, lookback_3, lookback_6):
    score = 0.0
    score += 0.4 * row.get(f"ret_{lookback_1}D", 0)
    score += 0.35 * row.get(f"ret_{lookback_3}D", 0)
    score += 0.25 * row.get(f"ret_{lookback_6}D", 0)
    score += 5.0 if row.get("above_50") else 0.0
    score += 5.0 if row.get("above_200") else 0.0
    dist_high = row.get("dist_52w_high_pct", np.nan)
    if not math.isnan(dist_high):
        if dist_high >= -3:
            score += 5.0
        elif dist_high >= -10:
            score += 2.5
    rsi_v = row.get("rsi14", np.nan)
    if not math.isnan(rsi_v):
        if 55 <= rsi_v <= 75:
            score += 3.0
        elif 50 <= rsi_v < 55:
            score += 1.0
        elif rsi_v > 80:
            score -= 2.0
    return score

def run_screen(tickers, lookback_1, lookback_3, lookback_6, min_dollar_vol, min_price, top_n, entry_mode, custom_entry, atr_k, risk_multiple_tp):
    if not tickers:
        st.info("‚ö†Ô∏è Ê≤íÊúâÂèØÁî®‰ª£Ëôü„ÄÇË´ãÊõ¥ÊèõËÇ°Á•®ÁØÑÂúçÊàñË≤º‰∏äËá™Ë®ÇÊ∏ÖÂñÆ„ÄÇ")
        return

    raw = fetch_history(tickers)
    records = []
    for tkr in tickers:
        try:
            df = raw[tkr].dropna().copy()
            if df.empty:
                continue
            df["SMA50"] = sma(df["Close"], 50)
            df["SMA200"] = sma(df["Close"], 200)
            df["RSI14"] = rsi(df["Close"], 14)
            df["ATR14"] = atr(df["High"], df["Low"], df["Close"], 14)
            df["ADVol20"] = average_dollar_volume(df["Close"], df["Volume"], 20)
            df[f"RET_{lookback_1}D"] = pct_change(df["Close"], lookback_1)
            df[f"RET_{lookback_3}D"] = pct_change(df["Close"], lookback_3)
            df[f"RET_{lookback_6}D"] = pct_change(df["Close"], lookback_6)
            df["HIGH_52W"] = df["Close"].rolling(252).max()
            df["dist_52w_high_pct"] = (df["Close"] / df["HIGH_52W"] - 1.0) * 100.0

            last = df.iloc[-1]
            if (last["ADVol20"] or 0) < min_dollar_vol: continue
            if last["Close"] < min_price: continue

            row = {
                "Ticker": tkr,
                "Price": last["Close"],
                f"ret_{lookback_1}D": last[f"RET_{lookback_1}D"],
                f"ret_{lookback_3}D": last[f"RET_{lookback_3}D"],
                f"ret_{lookback_6}D": last[f"RET_{lookback_6}D"],
                "above_50": bool(last["Close"] > last["SMA50"]),
                "above_200": bool(last["Close"] > last["SMA200"]),
                "rsi14": last["RSI14"],
                "dist_52w_high_pct": last["dist_52w_high_pct"],
                "atr14": last["ATR14"],
                "avg_dollar_vol_20d": last["ADVol20"],
            }

            close, stop, tp1, tp2, tp3, risk = compute_levels(df["Close"], df["ATR14"], atr_mult=atr_k)
            row.update({
                "stop_loss": stop,
                "tp_1R": tp1,
                "tp_2R": tp2,
                "tp_3R": tp3,
                "R(risk)": risk,
            })
            row["score"] = score_row(row, lookback_1, lookback_3, lookback_6)
            records.append(row)
        except Exception:
            continue

    if not records:
        st.warning("Ê≤íÊúâÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑËÇ°Á•®„ÄÇË©¶ËëóÊîæÂØ¨Êàê‰∫§È°çÊàñÂÉπÊ†ºÈñÄÊ™ª„ÄÇ")
        return

    out = pd.DataFrame(records).sort_values("score", ascending=False).reset_index(drop=True)
    st.subheader("üìà ÊéÉÊèèÁµêÊûúÔºàMomentum RankingÔºâ")
    st.dataframe(
        out.head(top_n).assign(
            Price=lambda d: d["Price"].map(format_price),
            rsi14=lambda d: d["rsi14"].round(1),
            dist_52w_high_pct=lambda d: d["dist_52w_high_pct"].round(2),
            atr14=lambda d: d["atr14"].map(format_price),
            stop_loss=lambda d: d["stop_loss"].map(format_price),
            tp_2R=lambda d: d["tp_2R"].map(format_price),
            tp_3R=lambda d: d["tp_3R"].map(format_price),
            **{f"ret_{lookback_1}D": lambda d: d[f"ret_{lookback_1}D"].round(1),
               f"ret_{lookback_3}D": lambda d: d[f"ret_{lookback_3}D"].round(1),
               f"ret_{lookback_6}D": lambda d: d[f"ret_{lookback_6}D"].round(1)}
        ),
        use_container_width=True,
        hide_index=True
    )

    st.markdown("---")
    sel = st.selectbox("Êü•ÁúãË©≥ÊÉÖÔºàÁπ™Âúñ & ÂÉπ‰ΩçÔºâ", out.head(top_n)["Ticker"].tolist())
    if sel:
        df = fetch_history(sel, period="400d")[sel].dropna().copy()
        df["SMA20"] = sma(df["Close"], 20)
        df["SMA50"] = sma(df["Close"], 50)
        df["SMA200"] = sma(df["Close"], 200)
        df["ATR14"] = atr(df["High"], df["Low"], df["Close"], 14)

        last_close, stop, tp1, tp2, tp3, risk = compute_levels(df["Close"], df["ATR14"], atr_mult=atr_k)

        if entry_mode == "Ëá™Ë®ÇÂÖ•Â†¥ÂÉπ" and custom_entry > 0:
            entry = custom_entry
            r = max(entry - stop, 0.01)
            tp = entry + risk_multiple_tp * r
        else:
            entry = last_close
            r = max(entry - stop, 0.01)
            tp = entry + risk_multiple_tp * r

        c1, c2, c3, c4 = st.columns(4)
        c1.metric("ÁèæÂÉπ", format_price(last_close))
        c2.metric("Ê≠¢Ëùï", format_price(stop))
        c3.metric(f"Ê≠¢Ë≥∫Ôºà{risk_multiple_tp}RÔºâ", format_price(tp))
        c4.metric("ATR(14)", format_price(df["ATR14"].iloc[-1]))

        st.line_chart(df[["Close", "SMA20", "SMA50", "SMA200"]])
        st.caption("Âª∫Ë≠∞ÔºöÊ≠¢ËùïÔºùmax(20Êó•‰Ωé, ÁèæÂÉπ - ATR√óÂÄçÊï∏)ÔºõÊ≠¢Ë≥∫ÔºùR ÂÄçÊï∏„ÄÇË´ã‰æùÂÄã‰∫∫È¢®Èö™ÊâøÂèóÂ∫¶Ë™øÊï¥„ÄÇ")

# ---------------------------
# Main
# ---------------------------
with st.expander("‚ùì Â¶ÇÊûúÊ∏ÖÂñÆÂèñÂæóÂ§±ÊïóÊÄéÈ∫ºËæ¶Ôºü", expanded=False):
    st.write("""
- S&P 500ÔºöÈÄôÂÄãÁâàÊú¨Â∑≤ÊîπÁÇ∫ÂÑ™ÂÖà‰ΩøÁî® `yfinance.tickers_sp500()`Ôºå‰∏¶‰ª• GitHub CSV ‰ΩúÁÇ∫ÂæåÊè¥„ÄÇ
- NASDAQ 100ÔºöËã•Á∂≠Âü∫ÊäìÂèñÂ§±ÊïóÔºåË´ãÊîπÁî®„ÄåËá™Ë®ÇÊ∏ÖÂñÆ„ÄçÔºå‰æãÂ¶ÇÊää **NDX Êàê‰ªΩ**ÂæûÁ∂≤Á´ôË§áË£ΩË≤º‰∏ä„ÄÇ
    """)

if st.sidebar.button("üîÅ ÈáçÊñ∞ÂòóË©¶ÂèñÂæóÊ∏ÖÂñÆ", help="Ëã•‰Ω†ÂâõÂàáÊèõÁ∂≤Ë∑ØÊàñ‰ª£ÁêÜÔºåÈªûÈÄôÂÄãÈáçÊñ∞ËºâÂÖ•Ê∏ÖÂñÆ"):
    st.cache_data.clear()

if st.sidebar.button("üîç ‰∏ÄÈçµÊéÉÊèè", key="run_scan_main"):
    run = True
else:
    run = False

# Mirror sidebar button behavior
if run:
    if universe == "Ëá™Ë®ÇÔºàË≤º‰∏ä‰ª£ËôüÔºåÈÄóËôüÊàñÁ©∫ÁôΩÂàÜÈöîÔºâ":
        custom = st.text_area("Ë≤º‰∏ä‰ª£ËôüÔºà‰æãÔºöAAPL, MSFT, NVDA ÊàñÊèõË°åÂàÜÈöîÔºâ", height=100)
        def parse_custom_tickers(raw: str):
            if not raw: return []
            parts = [p.strip().upper() for p in raw.replace("\n", " ").replace("\t", " ").replace(";", " ").replace("|"," ").split(" ") if p.strip()]
            out = []
            for item in parts:
                out.extend([x.strip() for x in item.split(",") if x.strip()])
            out = [x.replace(".", "-") for x in out if x.isascii()]
            return sorted(list(dict.fromkeys(out)))
        tickers = parse_custom_tickers(custom)
    else:
        tickers = get_universe_tickers(universe)

    run_screen(
        tickers=tickers,
        lookback_1=st.session_state.get('lookback_1', 21) if 'lookback_1' in st.session_state else 21,
        lookback_3=st.session_state.get('lookback_3', 63) if 'lookback_3' in st.session_state else 63,
        lookback_6=st.session_state.get('lookback_6', 126) if 'lookback_6' in st.session_state else 126,
        min_dollar_vol=st.session_state.get('min_dollar_vol', 2_000_000),
        min_price=st.session_state.get('min_price', 5.0),
        top_n=st.session_state.get('top_n', 15),
        entry_mode=st.session_state.get('entry_mode', "‰ΩøÁî®ÊúÄÊñ∞Êî∂Áõ§ÂÉπ"),
        custom_entry=st.session_state.get('custom_entry', 0.0),
        atr_k=st.session_state.get('atr_k', 2.0),
        risk_multiple_tp=st.session_state.get('risk_multiple_tp', 2.0),
    )
else:
    st.info("Âú®Â∑¶ÂÅ¥ÈÅ∏ÊìáËÇ°Á•®ÁØÑÂúçËàáÊ¢ù‰ª∂ÂæåÔºåÊåâ **üîç ‰∏ÄÈçµÊéÉÊèè** ÈñãÂßã„ÄÇ")
